esphome:
  name: m5atom-advantage-air
  friendly_name: Advantage Air AC Controller
  on_boot:
    priority: 100
    then:
      - lambda: id(request_state) = 0;

esp32:
  board: m5stack-atom
  variant: ESP32
  framework:
    type: arduino

substitutions:
  zone1_name: "Kitchen"
  zone2_name: "Master"
  zone3_name: "Guest"
  zone4_name: "Store"
  zone5_name: "Workroom"
  zone6_name: "Study"
  zone7_name: "Theatre"

logger:
  baud_rate: 115200
  level: INFO

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

uart:
  id: rs485_bus
  tx_pin: GPIO19
  rx_pin: GPIO22
  baud_rate: 57600
  data_bits: 8
  stop_bits: 1
  parity: NONE
  debug:
    direction: RX
    dummy_receiver: true
    after:
      timeout: 1000ms
    sequence:
      - lambda: |-
          std::string data;
          for (auto c : bytes) {
            if (c >= 32 && c < 127) data += static_cast<char>(c);
          }
          id(response_buffer) += data;

          size_t pos;
          while ((pos = id(response_buffer).find("</iZS10.3>")) != std::string::npos) {
            std::string response = id(response_buffer).substr(0, pos + 10);
            id(response_buffer) = id(response_buffer).substr(pos + 10);

            std::string log_response = response;
            if (log_response.length() > 800) log_response = log_response.substr(0, 800) + "...";
            ESP_LOGI("AC", "RX: %s", log_response.c_str());

            if (response.find("getSystemData") != std::string::npos) {
              id(debug_system_response) = response;
              
              auto extract = [&](const std::string& tag) {
                auto start = response.find("<" + tag + ">");
                if (start == std::string::npos) return std::string("");
                auto end = response.find("</" + tag + ">", start);
                if (end == std::string::npos) return std::string("");
                return response.substr(start + tag.size() + 2, end - start - tag.size() - 2);
              };
              
               std::string power = extract("airconOnOff");
               if (!power.empty()) {
                 id(ac_power) = (power == "1");
                 id(switch_ac_power).publish_state(power == "1");
               }

              std::string mode = extract("mode");
              if (!mode.empty() && millis() - id(last_set_time) > 5000) {
                id(ac_mode) = atoi(mode.c_str());
                switch(id(ac_mode)) {
                  case 1: 
                    id(select_ac_mode).publish_state("Cool");
                    break;
                  case 2: 
                    id(select_ac_mode).publish_state("Heat");
                    break;
                  case 3: 
                    id(select_ac_mode).publish_state("Fan");
                    break;
                  case 5: 
                    id(select_ac_mode).publish_state("Dry");
                    break;
                  default: 
                    id(select_ac_mode).publish_state("Cool");
                    break;
                }
              }

              std::string fan = extract("fanSpeed");
              if (!fan.empty() && millis() - id(last_set_time) > 5000) {
                id(ac_fan) = atoi(fan.c_str());
                switch(id(ac_fan)) {
                  case 1: 
                    id(select_fan_speed).publish_state("Low");
                    break;
                  case 2: 
                    id(select_fan_speed).publish_state("Medium");
                    break;
                  case 3: 
                    id(select_fan_speed).publish_state("High");
                    break;
                  case 4: 
                    id(select_fan_speed).publish_state("Auto");
                    break;
                  default: 
                    id(select_fan_speed).publish_state("Low");
                    break;
                }
              }

              std::string temp = extract("centralDesiredTemp");
              if (!temp.empty() && millis() - id(last_set_time) > 5000) id(ac_temp) = atof(temp.c_str());

              std::string myzone = extract("unitControlTempsSetting");
              if (!myzone.empty()) {
                int new_myzone = atoi(myzone.c_str());
                id(ac_myzone) = new_myzone;
                
                // Publish to select component so UI updates
                std::string zone_name;
                switch(new_myzone) {
                  case 0: zone_name = "Off"; break;
                  case 1: zone_name = "${zone1_name}"; break;
                  case 2: zone_name = "${zone2_name}"; break;
                  case 3: zone_name = "${zone3_name}"; break;
                  case 4: zone_name = "${zone4_name}"; break;
                  case 5: zone_name = "${zone5_name}"; break;
                  case 6: zone_name = "${zone6_name}"; break;
                  case 7: zone_name = "${zone7_name}"; break;
                  default: zone_name = "Off"; break;
                }
                id(select_myzone).publish_state(zone_name);
              }

              ESP_LOGI("AC", "System: power=%s, mode=%d, fan=%d, temp=%.1f, myzone=%d",
                       id(ac_power) ? "ON" : "OFF", id(ac_mode), id(ac_fan), id(ac_temp), id(ac_myzone));
            }

            if (response.find("<request>getZoneData</request>") != std::string::npos) {
              int zone_id = 0;
              auto zone_start = response.find("<zone");
              if (zone_start != std::string::npos) {
                for (int i = 0; i < 20 && zone_start + i < response.size(); i++) {
                  char c = response[zone_start + i];
                  if (c >= '0' && c <= '9') {
                    zone_id = c - '0';
                    break;
                  }
                  if (c == '>') break;
                }
              }

              auto zone_end = response.find("</zone" + std::to_string(zone_id) + ">", zone_start);
              if (zone_end == std::string::npos) zone_end = zone_start + 500;

              auto extract = [&](const std::string& tag) {
                auto start = response.find("<" + tag + ">", zone_start);
                if (start == std::string::npos || start > zone_end) return std::string("");
                auto end = response.find("</" + tag + ">", start);
                if (end == std::string::npos || end > zone_end) return std::string("");
                size_t cs = start + tag.size() + 2;
                if (end < cs) return std::string("");
                return response.substr(cs, end - cs);
              };

              std::string temp = extract("actualTemp");
              std::string setting = extract("setting");
              std::string rf = extract("RFstrength");
              std::string percent = extract("userPercentSetting");
              std::string maxDamper = extract("maxDamper");
              std::string desiredTemp = extract("desiredTemp");
              
              ESP_LOGD("AC", "Zone %d: raw desiredTemp extraction: '%s'", zone_id, desiredTemp.c_str());

              switch(zone_id) {
                case 1:
                  if (!temp.empty()) id(zone1_temp) = atof(temp.c_str());
                  if (!desiredTemp.empty() && millis() - id(last_set_time) > 5000) id(zone1_desired) = atof(desiredTemp.c_str());
                  if (!setting.empty()) {
                    id(zone1_open) = (setting == "1");
                    id(switch_zone1).publish_state(setting == "1");
                  }
                  if (!rf.empty()) id(zone1_rf) = atoi(rf.c_str());
                  break;
                case 2:
                  if (!temp.empty()) id(zone2_temp) = atof(temp.c_str());
                  if (!desiredTemp.empty() && millis() - id(last_set_time) > 5000) id(zone2_desired) = atof(desiredTemp.c_str());
                  if (!setting.empty()) {
                    id(zone2_open) = (setting == "1");
                    id(switch_zone2).publish_state(setting == "1");
                  }
                  if (!rf.empty()) id(zone2_rf) = atoi(rf.c_str());
                  break;
                case 3:
                  if (!temp.empty()) id(zone3_temp) = atof(temp.c_str());
                  if (!desiredTemp.empty() && millis() - id(last_set_time) > 5000) id(zone3_desired) = atof(desiredTemp.c_str());
                  if (!setting.empty()) {
                    id(zone3_open) = (setting == "1");
                    id(switch_zone3).publish_state(setting == "1");
                  }
                  if (!rf.empty()) id(zone3_rf) = atoi(rf.c_str());
                  break;
                case 4:
                  if (!percent.empty()) id(zone4_percent) = atoi(percent.c_str());
                  if (!setting.empty()) {
                    id(zone4_open) = (setting == "1");
                    id(switch_zone4).publish_state(setting == "1");
                  }
                  if (!maxDamper.empty()) id(zone4_max) = atoi(maxDamper.c_str());
                  break;
                case 5:
                  if (!percent.empty()) id(zone5_percent) = atoi(percent.c_str());
                  if (!setting.empty()) {
                    id(zone5_open) = (setting == "1");
                    id(switch_zone5).publish_state(setting == "1");
                  }
                  if (!maxDamper.empty()) id(zone5_max) = atoi(maxDamper.c_str());
                  break;
                case 6:
                  if (!percent.empty()) id(zone6_percent) = atoi(percent.c_str());
                  if (!setting.empty()) {
                    id(zone6_open) = (setting == "1");
                    id(switch_zone6).publish_state(setting == "1");
                  }
                  if (!maxDamper.empty()) id(zone6_max) = atoi(maxDamper.c_str());
                  break;
                case 7:
                  if (!temp.empty()) id(zone7_temp) = atof(temp.c_str());
                  if (!desiredTemp.empty() && millis() - id(last_set_time) > 5000) id(zone7_desired) = atof(desiredTemp.c_str());
                  if (!setting.empty()) {
                    id(zone7_open) = (setting == "1");
                    id(switch_zone7).publish_state(setting == "1");
                  }
                  if (!rf.empty()) id(zone7_rf) = atoi(rf.c_str());
                  break;
              }

              const char* open_str = setting.empty() ? "N/A" : (setting == "1" ? "YES" : "NO");
              const char* percent_str = percent.empty() ? "N/A" : percent.c_str();
              const char* rf_str = rf.empty() ? "N/A" : rf.c_str();
              float zone_temp = 0.0f;
              float zone_desired = 0.0f;
              if (zone_id == 1) { zone_temp = id(zone1_temp); zone_desired = id(zone1_desired); }
              else if (zone_id == 2) { zone_temp = id(zone2_temp); zone_desired = id(zone2_desired); }
              else if (zone_id == 3) { zone_temp = id(zone3_temp); zone_desired = id(zone3_desired); }
              else if (zone_id == 7) { zone_temp = id(zone7_temp); zone_desired = id(zone7_desired); }

              ESP_LOGI("AC", "Zone %d: temp=%.1f, desired=%.1f, open=%s, rf=%s, percent=%s",
                       zone_id, zone_temp, zone_desired, open_str, rf_str, percent_str);
            }
          }

globals:
  - id: ac_power
    type: bool
    initial_value: "false"
  - id: ac_mode
    type: int
    initial_value: "1"
  - id: ac_fan
    type: int
    initial_value: "1"
  - id: ac_temp
    type: float
    initial_value: "21.0"
  - id: ac_myzone
    type: int
    initial_value: "0"
  - id: last_set_time
    type: long
    initial_value: "0"
  - id: zone1_temp
    type: float
    initial_value: "0.0"
  - id: zone1_desired
    type: float
    initial_value: "0.0"
  - id: zone1_open
    type: bool
    initial_value: "false"
  - id: zone1_rf
    type: int
    initial_value: "0"
  - id: zone2_temp
    type: float
    initial_value: "0.0"
  - id: zone2_desired
    type: float
    initial_value: "0.0"
  - id: zone2_open
    type: bool
    initial_value: "false"
  - id: zone2_rf
    type: int
    initial_value: "0"
  - id: zone3_temp
    type: float
    initial_value: "0.0"
  - id: zone3_desired
    type: float
    initial_value: "0.0"
  - id: zone3_open
    type: bool
    initial_value: "false"
  - id: zone3_rf
    type: int
    initial_value: "0"
  - id: zone7_temp
    type: float
    initial_value: "0.0"
  - id: zone7_desired
    type: float
    initial_value: "0.0"
  - id: zone7_open
    type: bool
    initial_value: "false"
  - id: zone7_rf
    type: int
    initial_value: "0"
  - id: zone4_percent
    type: int
    initial_value: "100"
  - id: zone4_open
    type: bool
    initial_value: "false"
  - id: zone5_percent
    type: int
    initial_value: "100"
  - id: zone5_open
    type: bool
    initial_value: "false"
  - id: zone6_percent
    type: int
    initial_value: "30"
  - id: zone6_open
    type: bool
    initial_value: "false"
  - id: zone4_max
    type: int
    initial_value: "100"
  - id: zone5_max
    type: int
    initial_value: "100"
  - id: zone6_max
    type: int
    initial_value: "100"
  - id: response_buffer
    type: std::string
    initial_value: "\"\""
  - id: request_state
    type: int
    initial_value: "0"
  - id: aa_cmd_type
    type: int
    initial_value: "0"
  - id: aa_cmd_value
    type: float
    initial_value: "21.0"
  - id: aa_cmd_zone
    type: int
    initial_value: "1"
  - id: debug_system_response
    type: std::string
    initial_value: "\"\""

sensor:
  - platform: uptime
    name: "Uptime"

  - platform: template
    name: "${zone1_name} Temperature"
    id: sensor_zone1_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone1_temp);

  - platform: template
    name: "${zone1_name} Signal"
    id: sensor_zone1_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone1_rf);

  - platform: template
    name: "${zone2_name} Temperature"
    id: sensor_zone2_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone2_temp);

  - platform: template
    name: "${zone2_name} Signal"
    id: sensor_zone2_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone2_rf);

  - platform: template
    name: "${zone3_name} Temperature"
    id: sensor_zone3_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone3_temp);

  - platform: template
    name: "${zone3_name} Signal"
    id: sensor_zone3_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone3_rf);

  - platform: template
    name: "${zone7_name} Temperature"
    id: sensor_zone7_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone7_temp);

  - platform: template
    name: "${zone7_name} Signal"
    id: sensor_zone7_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone7_rf);

  - platform: template
    name: "${zone4_name} Percentage"
    id: sensor_zone4_percent
    unit_of_measurement: "%"
    lambda: return (float)id(zone4_percent);

  - platform: template
    name: "${zone6_name} Percentage"
    id: sensor_zone6_percent
    unit_of_measurement: "%"
    lambda: return (float)id(zone6_percent);

  - platform: template
    name: "${zone5_name} Percentage"
    id: sensor_zone5_percent
    unit_of_measurement: "%"
    lambda: return (float)id(zone5_percent);

text_sensor:
  - platform: template
    name: "AC Mode"
    id: sensor_ac_mode
    lambda: |
      switch(id(ac_mode)) {
        case 1: return std::string("Cool");
        case 2: return std::string("Heat");
        case 3: return std::string("Fan");
        case 5: return std::string("Dry");
        default: return std::string("Off");
      }

  - platform: template
    name: "Fan Speed"
    id: sensor_fan_speed
    lambda: |
      switch(id(ac_fan)) {
        case 1: return std::string("Low");
        case 2: return std::string("Medium");
        case 3: return std::string("High");
        case 4: return std::string("Auto");
        default: return std::string("Unknown");
      }

  - platform: template
    name: "MyZone"
    id: sensor_myzone
    lambda: |
      switch(id(ac_myzone)) {
        case 0: return std::string("Off");
        case 1: return std::string("${zone1_name}");
        case 2: return std::string("${zone2_name}");
        case 3: return std::string("${zone3_name}");
        case 4: return std::string("${zone4_name}");
        case 5: return std::string("${zone5_name}");
        case 6: return std::string("${zone6_name}");
        case 7: return std::string("${zone7_name}");
        default: return std::string("Unknown");
      }

  - platform: template
    name: "${zone1_name} Vent"
    id: sensor_zone1_vent
    lambda: 'return id(zone1_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "${zone2_name} Vent"
    id: sensor_zone2_vent
    lambda: 'return id(zone2_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "${zone3_name} Vent"
    id: sensor_zone3_vent
    lambda: 'return id(zone3_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "${zone7_name} Vent"
    id: sensor_zone7_vent
    lambda: 'return id(zone7_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "Debug System Response"
    id: sensor_debug_system
    lambda: return id(debug_system_response);

switch:
  - platform: template
    name: "AC Power"
    id: switch_ac_power
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setSystemData?airconOnOff=1</U=94>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setSystemData?airconOnOff=0</U=93>");

  - platform: template
    name: "${zone1_name}"
    id: switch_zone1
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=1&zoneSetting=1</U=2a>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=1&zoneSetting=0</U=14>");

  - platform: template
    name: "${zone2_name}"
    id: switch_zone2
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=2&zoneSetting=1</U=1e>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=2&zoneSetting=0</U=20>");

  - platform: template
    name: "${zone3_name}"
    id: switch_zone3
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=3&zoneSetting=1</U=d1>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=3&zoneSetting=0</U=ef>");

  - platform: template
    name: "${zone7_name}"
    id: switch_zone7
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=7&zoneSetting=1</U=42>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=7&zoneSetting=0</U=7c>");

  - platform: template
    name: "${zone4_name}"
    id: switch_zone4
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=4&zoneSetting=1</U=31>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=4&zoneSetting=0</U=17>");

  - platform: template
    name: "${zone5_name}"
    id: switch_zone5
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=5&zoneSetting=1</U=7e>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=5&zoneSetting=0</U=58>");

  - platform: template
    name: "${zone6_name}"
    id: switch_zone6
    optimistic: false
    turn_on_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=6&zoneSetting=1</U=7f>");
    turn_off_action:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=6&zoneSetting=0</U=59>");

cover:
  - platform: template
    name: "${zone1_name}"
    id: cover_zone1
    optimistic: false
    has_position: true
    lambda: |-
      return id(zone1_open) ? 1.0 : 0.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=1&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone1 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
            std::string cmd2 = "setZoneData?zone=1&userPercentSetting=100";
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
             ESP_LOGI("AC", "zone1: %s", formatted2.c_str());
             id(rs485_bus).write_str(formatted2.c_str());
             
             delay(100);
             
             // Send zoneSetting=1 again to keep zone enabled
             ESP_LOGI("AC", "zone1 zoneSetting again: %s", formatted1.c_str());
             id(rs485_bus).write_str(formatted1.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=1&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone1 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());

  - platform: template
    name: "${zone2_name}"
    id: cover_zone2
    optimistic: false
    has_position: true
    lambda: |-
      return id(zone2_open) ? 1.0 : 0.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=2&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone2 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
            std::string cmd2 = "setZoneData?zone=2&userPercentSetting=100";
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone2: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=2&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone2 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());
    position_action:
      then:
        - lambda: |-
            float target = pos;
            if (fabs(target - id(cover_zone2).position) < 0.01) {
              target = (target > 0.5) ? 0.4999 : 0.5001;
            }
            int percent = static_cast<int>(round(pos * 100 / 5.0)) * 5;
            
            std::string cmd1 = "setZoneData?zone=2&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone2 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=2&userPercentSetting=" + to_string(percent);
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
             ESP_LOGI("AC", "zone2: %s", formatted2.c_str());
             id(rs485_bus).write_str(formatted2.c_str());
             
             delay(100);
             
             // Send zoneSetting=1 again to keep zone enabled
             ESP_LOGI("AC", "zone2 zoneSetting again: %s CRC=d4", cmd1.c_str());
             id(rs485_bus).write_str(formatted1.c_str());

  - platform: template
    name: "${zone3_name}"
    id: cover_zone3
    optimistic: false
    has_position: true
    lambda: |-
      return id(zone3_open) ? 1.0 : 0.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=3&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone3 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
            std::string cmd2 = "setZoneData?zone=3&userPercentSetting=100";
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone3: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=3&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                 else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone3 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());
    position_action:
      then:
        - lambda: |-
            float target = pos;
            if (fabs(target - id(cover_zone3).position) < 0.01) {
              target = (target > 0.5) ? 0.4999 : 0.5001;
            }
            int percent = static_cast<int>(round(pos * 100 / 5.0)) * 5;
            
            std::string cmd1 = "setZoneData?zone=3&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone3 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=3&userPercentSetting=" + to_string(percent);
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
             ESP_LOGI("AC", "zone3: %s", formatted2.c_str());
             id(rs485_bus).write_str(formatted2.c_str());
             
             delay(100);
             
             // Send zoneSetting=1 again to keep zone enabled
             ESP_LOGI("AC", "zone3 zoneSetting again: %s CRC=d4", cmd1.c_str());
             id(rs485_bus).write_str(formatted1.c_str());

  - platform: template
    name: "${zone7_name}"
    id: cover_zone7
    optimistic: false
    has_position: true
    lambda: |-
      return id(zone7_open) ? 1.0 : 0.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=7&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone7 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
            std::string cmd2 = "setZoneData?zone=7&userPercentSetting=100";
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone7: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=7&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                 else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone7 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());
    position_action:
      then:
        - lambda: |-
            float target = pos;
            if (fabs(target - id(cover_zone7).position) < 0.01) {
              target = (target > 0.5) ? 0.4999 : 0.5001;
            }
            int percent = static_cast<int>(round(pos * 100 / 5.0)) * 5;
            
            std::string cmd1 = "setZoneData?zone=7&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone7 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=7&userPercentSetting=" + to_string(percent);
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
             ESP_LOGI("AC", "zone7: %s", formatted2.c_str());
             id(rs485_bus).write_str(formatted2.c_str());
             
             delay(100);
             
             // Send zoneSetting=1 again to keep zone enabled
             ESP_LOGI("AC", "zone7 zoneSetting again: %s CRC=d4", cmd1.c_str());
             id(rs485_bus).write_str(formatted1.c_str());

  - platform: template
    name: "${zone4_name}"
    id: cover_zone4
    optimistic: false
    has_position: true
    lambda: |-
      if (id(zone4_max) > 0) {
        return (float)id(zone4_percent) / (float)id(zone4_max);
      }
      return (float)id(zone4_percent) / 100.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=4&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone4 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
             std::string cmd2 = "setZoneData?zone=4&userPercentSetting=" + to_string(id(zone4_max));
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone4: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=4&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                 else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone4 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());
    position_action:
      then:
        - lambda: |-
            float target = pos;
             if (fabs(target - id(cover_zone4).position) < 0.01) {
               target = (target > 0.5) ? 0.4999 : 0.5001;
             }
              int percent = static_cast<int>(round(pos * id(zone4_max) / 5.0)) * 5;
            
            std::string cmd1 = "setZoneData?zone=4&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone4 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=4&userPercentSetting=" + to_string(percent);
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
             ESP_LOGI("AC", "zone4: %s", formatted2.c_str());
             id(rs485_bus).write_str(formatted2.c_str());
             
             delay(100);
             
             // Send zoneSetting=1 again to keep zone enabled
             ESP_LOGI("AC", "zone4 zoneSetting again: %s CRC=d4", cmd1.c_str());
             id(rs485_bus).write_str(formatted1.c_str());

  - platform: template
    name: "${zone5_name}"
    id: cover_zone5
    optimistic: false
    has_position: true
    lambda: |-
      if (id(zone5_max) > 0) {
        return (float)id(zone5_percent) / (float)id(zone5_max);
      }
      return (float)id(zone5_percent) / 100.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=5&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone5 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
             std::string cmd2 = "setZoneData?zone=5&userPercentSetting=" + to_string(id(zone5_max));
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone5: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=5&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                 else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone5 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());
    position_action:
      then:
        - lambda: |-
            float target = pos;
             if (fabs(target - id(cover_zone5).position) < 0.01) {
               target = (target > 0.5) ? 0.4999 : 0.5001;
             }
              int percent = static_cast<int>(round(pos * id(zone5_max) / 5.0)) * 5;
            
            std::string cmd1 = "setZoneData?zone=5&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone5 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=5&userPercentSetting=" + to_string(percent);
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
             ESP_LOGI("AC", "zone5: %s", formatted2.c_str());
             id(rs485_bus).write_str(formatted2.c_str());
             
             delay(100);
             
             // Send zoneSetting=1 again to keep zone enabled
             ESP_LOGI("AC", "zone5 zoneSetting again: %s CRC=d4", cmd1.c_str());
             id(rs485_bus).write_str(formatted1.c_str());

  - platform: template
    name: "${zone6_name}"
    id: cover_zone6
    optimistic: false
    has_position: true
    lambda: |-
      if (id(zone6_max) > 0) {
        return (float)id(zone6_percent) / (float)id(zone6_max);
      }
      return (float)id(zone6_percent) / 100.0;
    open_action:
      then:
        - lambda: |-
            std::string cmd1 = "setZoneData?zone=6&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone6 setting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
            
            ESP_LOGI("AC", "zone6 setting again: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=6&userPercentSetting=" + to_string(id(zone6_max));
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone6: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
    close_action:
      then:
        - lambda: |-
            std::string cmd = "setZoneData?zone=6&zoneSetting=0";
            uint8_t crc = 0x9B;
            for (char c : cmd) {
              crc ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
                 else crc >>= 1;
              }
            }
            char crc_str[8];
            snprintf(crc_str, sizeof(crc_str), "%02x", crc);
            std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
            ESP_LOGI("AC", "zone6 close: %s", formatted.c_str());
            id(rs485_bus).write_str(formatted.c_str());
    position_action:
      then:
        - lambda: |-
            float target = pos;
            if (fabs(target - id(cover_zone6).position) < 0.01) {
              target = (target > 0.5) ? 0.4999 : 0.5001;
            }
            int percent = static_cast<int>(round(pos * id(zone6_max) / 5.0)) * 5;
            
            std::string cmd1 = "setZoneData?zone=6&zoneSetting=1";
            uint8_t crc1 = 0x9B;
            for (char c : cmd1) {
              crc1 ^= (uint8_t)c;
              for (int i = 0; i < 8; i++) {
                if (crc1 & 0x01) crc1 = (crc1 >> 1) ^ 0xB2;
                else crc1 >>= 1;
              }
            }
            char crc1_str[8];
            snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
            std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
            ESP_LOGI("AC", "zone6 zoneSetting: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());
            
            delay(100);
            
            std::string cmd2 = "setZoneData?zone=6&userPercentSetting=" + to_string(percent);
            uint8_t crc2 = 0xBA;
            for (char c : cmd2) {
              crc2 ^= static_cast<uint8_t>(c);
              for (int i = 0; i < 8; i++) {
                if (crc2 & 0x01) crc2 = (crc2 >> 1) ^ 0xB2;
                else crc2 >>= 1;
              }
            }
            char crc2_str[8];
            snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
            std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
            ESP_LOGI("AC", "zone6: %s", formatted2.c_str());
            id(rs485_bus).write_str(formatted2.c_str());
            
            delay(100);
            
            ESP_LOGI("AC", "zone6 zoneSetting again: %s", formatted1.c_str());
            id(rs485_bus).write_str(formatted1.c_str());

number:
  - platform: template
    name: "Central Target Temperature"
    id: central_number_target_temp
    min_value: 16
    max_value: 30
    step: 0.5
    lambda: return id(ac_temp);
    optimistic: false
    set_action:
      - lambda: |
          char temp_str[8];
          snprintf(temp_str, sizeof(temp_str), "%.1f", x);
          std::string cmd = "setSystemData?centralDesiredTemp=" + std::string(temp_str);
          id(ac_temp) = x;
          id(last_set_time) = millis();
          uint8_t crc = 0;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x80) crc = (crc << 1) ^ 0x07;
              else crc <<= 1;
              crc &= 0xFF;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          id(rs485_bus).write_str(formatted.c_str());
          id(central_number_target_temp).publish_state(x);

  - platform: template
    name: "${zone1_name} Target"
    id: number_zone1_temp
    min_value: 16
    max_value: 30
    step: 0.5
    lambda: return id(zone1_desired);
    optimistic: false
    set_action:
      - lambda: |
          char temp_str[16];
          snprintf(temp_str, sizeof(temp_str), "%.1f", x);
          std::string cmd = std::string("setZoneData?zone=1&desiredTemp=") + temp_str;
          uint8_t crc = 0x62;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
              else crc >>= 1;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          ESP_LOGI("AC", "Setting zone1 temp to %.1f: %s", x, formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(zone1_desired) = x;
          id(last_set_time) = millis();
          id(number_zone1_temp).publish_state(x);

  - platform: template
    name: "${zone2_name} Target"
    id: number_zone2_temp
    min_value: 16
    max_value: 30
    step: 0.5
    lambda: return id(zone2_desired);
    optimistic: false
    set_action:
      - lambda: |
          char temp_str[16];
          snprintf(temp_str, sizeof(temp_str), "%.1f", x);
          std::string cmd = std::string("setZoneData?zone=2&desiredTemp=") + temp_str;
          uint8_t crc = 0x62;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
              else crc >>= 1;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          ESP_LOGI("AC", "Setting zone2 temp to %.1f: %s", x, formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(zone2_desired) = x;
          id(last_set_time) = millis();
          id(number_zone2_temp).publish_state(x);

  - platform: template
    name: "${zone3_name} Target"
    id: number_zone3_temp
    min_value: 16
    max_value: 30
    step: 0.5
    lambda: return id(zone3_desired);
    optimistic: false
    set_action:
      - lambda: |
          char temp_str[16];
          snprintf(temp_str, sizeof(temp_str), "%.1f", x);
          std::string cmd = std::string("setZoneData?zone=3&desiredTemp=") + temp_str;
          uint8_t crc = 0x62;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
              else crc >>= 1;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          ESP_LOGI("AC", "Setting zone3 temp to %.1f: %s", x, formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(zone3_desired) = x;
          id(last_set_time) = millis();
          id(number_zone3_temp).publish_state(x);

  - platform: template
    name: "${zone7_name} Target"
    id: number_zone7_temp
    min_value: 16
    max_value: 30
    step: 0.5
    lambda: return id(zone7_desired);
    optimistic: false
    set_action:
      - lambda: |
          char temp_str[16];
          snprintf(temp_str, sizeof(temp_str), "%.1f", x);
          std::string cmd = std::string("setZoneData?zone=7&desiredTemp=") + temp_str;
          uint8_t crc = 0x62;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
              else crc >>= 1;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          ESP_LOGI("AC", "Setting zone7 temp to %.1f: %s", x, formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(zone7_desired) = x;
          id(last_set_time) = millis();
          id(number_zone7_temp).publish_state(x);

  - platform: template
    name: "${zone4_name} Percentage"
    id: number_zone4_percent
    min_value: 0
    max_value: 100
    step: 10
    initial_value: 100
    optimistic: false
    set_action:
      - lambda: |
          id(number_zone4_percent).publish_state(x);
          
          std::string cmd1 = "setZoneData?zone=4&zoneSetting=1";
          uint8_t crc1 = 0x9B;
          for (char c : cmd1) {
            crc1 ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc1 & 0x80) crc1 = (crc1 << 1) ^ 0x07;
              else crc1 <<= 1;
              crc1 &= 0xFF;
            }
          }
          char crc1_str[8];
          snprintf(crc1_str, sizeof(crc1_str), "%02x", crc1);
          std::string formatted1 = "<U>" + cmd1 + "</U=" + std::string(crc1_str) + ">";
          
          ESP_LOGI("AC", "Opening zone4: %s", formatted1.c_str());
          id(rs485_bus).write_str(formatted1.c_str());
          delay(100);
          
          std::string cmd2 = "setZoneData?zone=4&userPercentSetting=" + to_string((int)x);
          uint8_t crc2 = 0;
          for (char c : cmd2) {
            crc2 ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc2 & 0x80) crc2 = (crc2 << 1) ^ 0x39;
              else crc2 <<= 1;
              crc2 &= 0xFF;
            }
          }
          crc2 = ((crc2 & 0x0F) << 4) | ((crc2 & 0xF0) >> 4);
          crc2 = ((crc2 & 0x33) << 2) | ((crc2 & 0xCC) >> 2);
          crc2 = ((crc2 & 0x55) << 1) | ((crc2 & 0xAA) >> 1);
          char crc2_str[8];
          snprintf(crc2_str, sizeof(crc2_str), "%02x", crc2);
          std::string formatted2 = "<U>" + cmd2 + "</U=" + std::string(crc2_str) + ">";
          
          ESP_LOGI("AC", "Setting zone4 percent to %d: %s", (int)x, formatted2.c_str());
          id(rs485_bus).write_str(formatted2.c_str());

select:
  - platform: template
    name: "AC Mode"
    id: select_ac_mode
    options:
      - "Cool"
      - "Heat"
      - "Fan"
      - "Dry"
    initial_option: "Cool"
    optimistic: false
    set_action:
      - lambda: |
          int mode = 1;
          if (x == "Heat") mode = 2;
          else if (x == "Fan") mode = 3;
          else if (x == "Dry") mode = 5;
          std::string cmd = "setSystemData?mode=" + to_string(mode);
          uint8_t crc = 0x40;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
              else crc >>= 1;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          ESP_LOGI("AC", "Setting AC mode to %s: %s", x.c_str(), formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(last_set_time) = millis();

  - platform: template
    name: "Fan Speed"
    id: select_fan_speed
    options:
      - "Low"
      - "Medium"
      - "High"
      - "Auto"
    initial_option: "Low"
    optimistic: false
    set_action:
      - lambda: |
          std::string mode = std::string(x);
          int speed = 1;
          if (mode == "Medium") speed = 2;
          else if (mode == "High") speed = 3;
          else if (mode == "Auto") speed = 4;
          std::string cmd = "setSystemData?fanSpeed=" + to_string(speed);
          uint8_t crc = 0x79;
          for (char c : cmd) {
            crc ^= (uint8_t)c;
            for (int i = 0; i < 8; i++) {
              if (crc & 0x01) crc = (crc >> 1) ^ 0xB2;
              else crc >>= 1;
            }
          }
          char crc_str[8];
          snprintf(crc_str, sizeof(crc_str), "%02x", crc);
          std::string formatted = "<U>" + cmd + "</U=" + std::string(crc_str) + ">";
          ESP_LOGI("AC", "Setting fan speed to %s: %s", mode.c_str(), formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(last_set_time) = millis();

  - platform: template
    name: "MyZone"
    id: select_myzone
    options:
      - "Off"
      - "${zone1_name}"
      - "${zone2_name}"
      - "${zone3_name}"
      - "${zone4_name}"
      - "${zone5_name}"
      - "${zone6_name}"
      - "${zone7_name}"
    lambda: |-
      switch(id(ac_myzone)) {
        case 0: return std::string("Off");
        case 1: return std::string("${zone1_name}");
        case 2: return std::string("${zone2_name}");
        case 3: return std::string("${zone3_name}");
        case 4: return std::string("${zone4_name}");
        case 5: return std::string("${zone5_name}");
        case 6: return std::string("${zone6_name}");
        case 7: return std::string("${zone7_name}");
        default: return std::string("Off");
      }
    optimistic: false
    set_action:
      - lambda: |
          std::string zone = std::string(x);
          int zone_id = 0;
          if (zone == "${zone1_name}") zone_id = 1;
          else if (zone == "${zone2_name}") zone_id = 2;
          else if (zone == "${zone3_name}") zone_id = 3;
          else if (zone == "${zone4_name}") zone_id = 4;
          else if (zone == "${zone5_name}") zone_id = 5;
          else if (zone == "${zone6_name}") zone_id = 6;
          else if (zone == "${zone7_name}") zone_id = 7;
          // Use hardcoded CRCs from sniffed data
          std::string cmd;
          std::string crc_str;
          switch(zone_id) {
            case 0: cmd = "setSystemData?unitControlTempsSetting=0"; crc_str = "22"; break;
            case 1: cmd = "setSystemData?unitControlTempsSetting=1"; crc_str = "1c"; break;
            case 2: cmd = "setSystemData?unitControlTempsSetting=2"; crc_str = "5e"; break;
            case 3: cmd = "setSystemData?unitControlTempsSetting=3"; crc_str = "60"; break;
            case 4: cmd = "setSystemData?unitControlTempsSetting=4"; crc_str = "2b"; break;
            case 5: cmd = "setSystemData?unitControlTempsSetting=5"; crc_str = "2a"; break;
            case 6: cmd = "setSystemData?unitControlTempsSetting=6"; crc_str = "25"; break;
            case 7: cmd = "setSystemData?unitControlTempsSetting=7"; crc_str = "98"; break;
            default: cmd = ""; crc_str = "00"; break;
          }
          std::string formatted = "<U>" + cmd + "</U=" + crc_str + ">";
          ESP_LOGI("AC", "Setting MyZone to %s: %s", zone.c_str(), formatted.c_str());
          id(rs485_bus).write_str(formatted.c_str());
          id(ac_myzone) = zone_id;
          id(last_set_time) = millis();

button:
  - platform: template
    name: "Refresh Status"
    on_press:
      - lambda: |
          id(request_state) = 0;
          id(rs485_bus).write_str("<U>Ping</U=db>");

interval:
  - interval: 30s
    then:
      - lambda: |
          id(request_state) = 0;

  - interval: 1s
    then:
      - lambda: |
          int state = id(request_state);
          switch(state) {
            case 0:
              id(rs485_bus).write_str("<U>Ping</U=db>");
              id(request_state) = 1;
              break;
            case 1:
              id(rs485_bus).write_str("<U>getSystemData</U=15>");
              id(request_state) = 2;
              break;
            case 2:
              id(rs485_bus).write_str("<U>getZoneData?zone=1</U=74>");
              id(request_state) = 3;
              break;
            case 3:
              id(rs485_bus).write_str("<U>getZoneData?zone=2</U=36>");
              id(request_state) = 4;
              break;
            case 4:
              id(rs485_bus).write_str("<U>getZoneData?zone=3</U=08>");
              id(request_state) = 5;
              break;
            case 5:
              id(rs485_bus).write_str("<U>getZoneData?zone=4</U=b2>");
              id(request_state) = 6;
              break;
            case 6:
              id(rs485_bus).write_str("<U>getZoneData?zone=5</U=8c>");
              id(request_state) = 7;
              break;
            case 7:
              id(rs485_bus).write_str("<U>getZoneData?zone=6</U=ce>");
              id(request_state) = 8;
              break;
            case 8:
              id(rs485_bus).write_str("<U>getZoneData?zone=7</U=f0>");
              id(request_state) = 9;
              break;
            case 9:
              id(request_state) = 0;
              break;
          }
