esphome:
  name: m5atom-advantage-air
  friendly_name: Advantage Air AC Controller

esp32:
  variant: ESP32
  framework:
    type: arduino

logger:
  baud_rate: 115200
  level: INFO

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

external_components:
  - source: github://D3LZ-D3LZ-D3LZ/EzoneEsphome
    refresh: 0d

uart:
  id: rs485_bus
  tx_pin: GPIO19
  rx_pin: GPIO22
  baud_rate: 57600
  data_bits: 8
  stop_bits: 1
  parity: NONE
  debug:
    direction: RX
    dummy_receiver: true
    after:
      timeout: 1000ms
    sequence:
      - lambda: |-
          std::string response;
          for (auto c : bytes) {
            if (c >= 32 && c < 127) response += static_cast<char>(c);
          }
          ESP_LOGI("AC", "RX: %s", response.c_str());

          if (response.find("<request>getSystemData</request>") != std::string::npos) {
            auto extract = [&](const std::string& tag) {
              auto start = response.find("<" + tag + ">");
              if (start == std::string::npos) return std::string("");
              auto end = response.find("</" + tag + ">", start);
              if (end == std::string::npos) return std::string("");
              return response.substr(start + tag.size() + 2, end - start - tag.size() - 2);
            };

            std::string power = extract("airconOnOff");
            if (!power.empty()) id(ac_power) = (power == "1");

            std::string mode = extract("mode");
            if (!mode.empty()) id(ac_mode) = atoi(mode.c_str());

            std::string fan = extract("fanSpeed");
            if (!fan.empty()) id(ac_fan) = atoi(fan.c_str());

            std::string temp = extract("centralDesiredTemp");
            if (!temp.empty()) id(ac_temp) = atof(temp.c_str());

            ESP_LOGI("AC", "System: power=%s, mode=%d, fan=%d, temp=%.1f",
                     id(ac_power) ? "ON" : "OFF", id(ac_mode), id(ac_fan), id(ac_temp));
          }

          if (response.find("<request>getZoneData</request>") != std::string::npos) {
            auto zone_pos = response.find("zone");
            if (zone_pos != std::string::npos && zone_pos + 5 < response.size()) {
              int zone_id = response[zone_pos + 4] - '0';

              auto extract = [&](const std::string& tag) {
                auto start = response.find("<" + tag + ">");
                if (start == std::string::npos) return std::string("");
                auto end = response.find("</" + tag + ">", start);
                if (end == std::string::npos) return std::string("");
                return response.substr(start + tag.size() + 2, end - start - tag.size() - 2);
              };

              std::string temp = extract("actualTemp");
              std::string setting = extract("setting");
              std::string rf = extract("RFstrength");
              std::string percent = extract("userPercentSetting");

              const char* open_str = "N/A";
              const char* percent_str = percent.empty() ? "N/A" : percent.c_str();
              switch(zone_id) {
                case 1:
                  if (!temp.empty()) id(zone1_temp) = atof(temp.c_str());
                  if (!setting.empty()) id(zone1_open) = (setting == "1");
                  if (!rf.empty()) id(zone1_rf) = atoi(rf.c_str());
                  open_str = id(zone1_open) ? "YES" : "NO";
                  break;
                case 2:
                  if (!temp.empty()) id(zone2_temp) = atof(temp.c_str());
                  if (!setting.empty()) id(zone2_open) = (setting == "1");
                  if (!rf.empty()) id(zone2_rf) = atoi(rf.c_str());
                  open_str = id(zone2_open) ? "YES" : "NO";
                  break;
                case 3:
                  if (!temp.empty()) id(zone3_temp) = atof(temp.c_str());
                  if (!setting.empty()) id(zone3_open) = (setting == "1");
                  if (!rf.empty()) id(zone3_rf) = atoi(rf.c_str());
                  open_str = id(zone3_open) ? "YES" : "NO";
                  break;
                case 4:
                  if (!percent.empty()) id(zone4_percent) = atoi(percent.c_str());
                  percent_str = percent.c_str();
                  break;
                case 5:
                  if (!percent.empty()) id(zone5_percent) = atoi(percent.c_str());
                  percent_str = percent.c_str();
                  break;
                case 6:
                  if (!percent.empty()) id(zone6_percent) = atoi(percent.c_str());
                  percent_str = percent.c_str();
                  break;
                case 7:
                  if (!temp.empty()) id(zone7_temp) = atof(temp.c_str());
                  if (!setting.empty()) id(zone7_open) = (setting == "1");
                  if (!rf.empty()) id(zone7_rf) = atoi(rf.c_str());
                  open_str = id(zone7_open) ? "YES" : "NO";
                  break;
              }

              float zone_temp = 0.0f;
              if (zone_id == 1) zone_temp = id(zone1_temp);
              else if (zone_id == 2) zone_temp = id(zone2_temp);
              else if (zone_id == 3) zone_temp = id(zone3_temp);
              else if (zone_id == 7) zone_temp = id(zone7_temp);

              ESP_LOGI("AC", "Zone %d: temp=%.1f, open=%s, rf=%s, percent=%s",
                       zone_id, zone_temp, open_str, rf.c_str(), percent_str);
            }
          }

globals:
  - id: ac_power
    type: bool
    initial_value: "false"
  - id: ac_mode
    type: int
    initial_value: "1"
  - id: ac_fan
    type: int
    initial_value: "1"
  - id: ac_temp
    type: float
    initial_value: "21.0"
  - id: zone1_temp
    type: float
    initial_value: "0.0"
  - id: zone1_open
    type: bool
    initial_value: "false"
  - id: zone1_rf
    type: int
    initial_value: "0"
  - id: zone2_temp
    type: float
    initial_value: "0.0"
  - id: zone2_open
    type: bool
    initial_value: "false"
  - id: zone2_rf
    type: int
    initial_value: "0"
  - id: zone3_temp
    type: float
    initial_value: "0.0"
  - id: zone3_open
    type: bool
    initial_value: "false"
  - id: zone3_rf
    type: int
    initial_value: "0"
  - id: zone7_temp
    type: float
    initial_value: "0.0"
  - id: zone7_open
    type: bool
    initial_value: "false"
  - id: zone7_rf
    type: int
    initial_value: "0"
  - id: zone4_percent
    type: int
    initial_value: "100"
  - id: zone5_percent
    type: int
    initial_value: "100"
  - id: zone6_percent
    type: int
    initial_value: "30"

sensor:
  - platform: uptime
    name: "Uptime"

  - platform: template
    name: "Kitchen Temperature"
    id: sensor_kitchen_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone1_temp);

  - platform: template
    name: "Kitchen Signal"
    id: sensor_kitchen_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone1_rf);

  - platform: template
    name: "Master Temperature"
    id: sensor_master_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone2_temp);

  - platform: template
    name: "Master Signal"
    id: sensor_master_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone2_rf);

  - platform: template
    name: "Guest Temperature"
    id: sensor_guest_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone3_temp);

  - platform: template
    name: "Guest Signal"
    id: sensor_guest_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone3_rf);

  - platform: template
    name: "Theatre Temperature"
    id: sensor_theatre_temp
    unit_of_measurement: "째C"
    accuracy_decimals: 1
    lambda: return id(zone7_temp);

  - platform: template
    name: "Theatre Signal"
    id: sensor_theatre_signal
    unit_of_measurement: "%"
    lambda: return (float)id(zone7_rf);

  - platform: template
    name: "Store Percentage"
    id: sensor_store_percent
    unit_of_measurement: "%"
    lambda: return (float)id(zone4_percent);

  - platform: template
    name: "Study Percentage"
    id: sensor_study_percent
    unit_of_measurement: "%"
    lambda: return (float)id(zone5_percent);

  - platform: template
    name: "Workroom Percentage"
    id: sensor_workroom_percent
    unit_of_measurement: "%"
    lambda: return (float)id(zone6_percent);

text_sensor:
  - platform: template
    name: "Kitchen Vent"
    id: sensor_kitchen_vent
    lambda: 'return id(zone1_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "Master Vent"
    id: sensor_master_vent
    lambda: 'return id(zone2_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "Guest Vent"
    id: sensor_guest_vent
    lambda: 'return id(zone3_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "Theatre Vent"
    id: sensor_theatre_vent
    lambda: 'return id(zone7_open) ? std::string("Open") : std::string("Closed");'

  - platform: template
    name: "AC Mode"
    id: sensor_ac_mode
    lambda: |
      switch(id(ac_mode)) {
        case 1: return std::string("Cool");
        case 2: return std::string("Heat");
        case 3: return std::string("Fan");
        default: return std::string("Off");
      }

  - platform: template
    name: "Fan Speed"
    id: sensor_fan_speed
    lambda: |
      switch(id(ac_fan)) {
        case 1: return std::string("Low");
        case 2: return std::string("Medium");
        case 3: return std::string("High");
        default: return std::string("Auto");
      }

switch:
  - platform: template
    name: "AC Power"
    id: switch_ac_power
    optimistic: true
    on_turn_on:
      - lambda: id(rs485_bus).write_str("<U>setSystemData?airconOnOff=1</U=XX>");
    on_turn_off:
      - lambda: id(rs485_bus).write_str("<U>setSystemData?airconOnOff=0</U=XX>");

  - platform: template
    name: "Zone 1"
    id: switch_zone1
    optimistic: true
    on_turn_on:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=1&setting=1</U=b6>");
    on_turn_off:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=1&setting=0</U=b7>");

  - platform: template
    name: "Zone 2"
    id: switch_zone2
    optimistic: true
    on_turn_on:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=2&setting=1</U=36>");
    on_turn_off:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=2&setting=0</U=37>");

  - platform: template
    name: "Zone 3"
    id: switch_zone3
    optimistic: true
    on_turn_on:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=3&setting=1</U=fe>");
    on_turn_off:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=3&setting=0</U=ff>");

  - platform: template
    name: "Zone 7"
    id: switch_zone7
    optimistic: true
    on_turn_on:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=7&setting=1</U=79>");
    on_turn_off:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=7&setting=0</U=7a>");

cover:
  - platform: template
    name: "Store"
    id: cover_store
    optimistic: true
    on_open:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=4&setting=1</U=3e>");
    on_closed:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=4&setting=0</U=3f>");

  - platform: template
    name: "Study"
    id: cover_study
    optimistic: true
    on_open:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=5&setting=1</U=be>");
    on_closed:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=5&setting=0</U=bf>");

  - platform: template
    name: "Workroom"
    id: cover_workroom
    optimistic: true
    on_open:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=6&setting=1</U=7e>");
    on_closed:
      - lambda: id(rs485_bus).write_str("<U>setZoneData?zone=6&setting=0</U=7f>");

number:
  - platform: template
    name: "Target Temperature"
    id: number_target_temp
    min_value: 16
    max_value: 30
    step: 0.5
    initial_value: 21
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setSystemData?centralDesiredTemp=" + to_string(x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Kitchen Target"
    id: number_kitchen_temp
    min_value: 16
    max_value: 30
    step: 0.5
    initial_value: 21
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=1&desiredTemp=" + to_string(x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Master Target"
    id: number_master_temp
    min_value: 16
    max_value: 30
    step: 0.5
    initial_value: 21
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=2&desiredTemp=" + to_string(x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Guest Target"
    id: number_guest_temp
    min_value: 16
    max_value: 30
    step: 0.5
    initial_value: 21
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=3&desiredTemp=" + to_string(x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Theatre Target"
    id: number_theatre_temp
    min_value: 16
    max_value: 30
    step: 0.5
    initial_value: 21
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=7&desiredTemp=" + to_string(x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Store Percentage"
    id: number_store_percent
    min_value: 0
    max_value: 100
    step: 10
    initial_value: 100
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=4&userPercentSetting=" + to_string((int)x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Study Percentage"
    id: number_study_percent
    min_value: 0
    max_value: 100
    step: 10
    initial_value: 100
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=5&userPercentSetting=" + to_string((int)x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

  - platform: template
    name: "Workroom Percentage"
    id: number_workroom_percent
    min_value: 0
    max_value: 100
    step: 10
    initial_value: 30
    optimistic: true
    set_action:
      - lambda: 'std::string cmd = "<U>setZoneData?zone=6&userPercentSetting=" + to_string((int)x) + "</U=XX>"; id(rs485_bus).write_str(cmd.c_str());'

select:
  - platform: template
    name: "AC Mode"
    id: select_ac_mode
    options:
      - "Cool"
      - "Heat"
      - "Fan"
    initial_option: "Cool"
    optimistic: true
    set_action:
      - lambda: |
          int mode = 1;
          if (x == "Heat") mode = 2;
          else if (x == "Fan") mode = 3;
          std::string cmd = "<U>setSystemData?mode=" + to_string(mode) + "</U=XX>";
          id(rs485_bus).write_str(cmd.c_str());

  - platform: template
    name: "Fan Speed"
    id: select_fan_speed
    options:
      - "Low"
      - "Medium"
      - "High"
    initial_option: "Low"
    optimistic: true
    set_action:
      - lambda: |
          int speed = 1;
          if (x == "Medium") speed = 2;
          else if (x == "High") speed = 3;
          std::string cmd = "<U>setSystemData?fanSpeed=" + to_string(speed) + "</U=XX>";
          id(rs485_bus).write_str(cmd.c_str());

  - platform: template
    name: "MyZone"
    id: select_myzones
    options:
      - "Kitchen"
      - "Master"
      - "Guest"
      - "Theatre"
    initial_option: "Kitchen"
    optimistic: true
    set_action:
      - lambda: |
          int zone = 1;
          if (x == "Master") zone = 2;
          else if (x == "Guest") zone = 3;
          else if (x == "Theatre") zone = 7;
          std::string cmd = "<U>setMyZone?zone=" + to_string(zone) + "</U=XX>";
          id(rs485_bus).write_str(cmd.c_str());

button:
  - platform: template
    name: "Refresh Status"
    on_press:
      - lambda: |
          id(rs485_bus).write_str("<U>Ping</U=db>");
          delay(10);
          id(rs485_bus).write_str("<U>getSystemData</U=15>");

interval:
  - interval: 30s
    then:
      - lambda: |
          id(rs485_bus).write_str("<U>Ping</U=db>");
          delay(10);
          id(rs485_bus).write_str("<U>getSystemData</U=15>");
          delay(30);
          id(rs485_bus).write_str("<U>getZoneData?zone=1</U=74>");
          delay(20);
          id(rs485_bus).write_str("<U>getZoneData?zone=2</U=36>");
          delay(20);
          id(rs485_bus).write_str("<U>getZoneData?zone=3</U=08>");
          delay(20);
          id(rs485_bus).write_str("<U>getZoneData?zone=7</U=f0>");
